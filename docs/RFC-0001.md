# RFC-0001: PoolManager Architecture

**Status:** Draft  
**Created:** 2025-08-16  
**Updated:** 2025-08-16  

## Overview

PoolManager is a personal NFL pool management system supporting ATS, SU, Points Plus, and Survivor pools. The system uses a deterministic numeric model as the primary decision engine, with optional LLM advisors for enhancement.

## Architecture

### System Components

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend API    │    │   Database      │
│   (Next.js)     │◄──►│   (Next.js API)  │◄──►│   (PostgreSQL)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                               │
                               ▼
                       ┌──────────────────┐
                       │   External APIs  │
                       │   • Odds/Lines   │
                       │   • Weather      │
                       │   • Scores       │
                       └──────────────────┘
                               │
                               ▼
                       ┌──────────────────┐
                       │   LLM Services   │
                       │   • OCR Normal.  │
                       │   • Advisor      │
                       └──────────────────┘
```

### Tech Stack

- **Runtime:** Node.js 22.x (ESM modules)
- **Framework:** Next.js 14+ (App Router)
- **Database:** PostgreSQL + Prisma ORM
- **UI:** React + TypeScript + Tailwind CSS + shadcn/ui
- **Testing:** Vitest + @testing-library/react + happy-dom
- **Jobs:** node-cron (lightweight scheduling)
- **Deployment:** Docker (GitHub Actions → GHCR)

### Directory Structure

```
/src/app                # Next.js App Router pages
/src/components         # Shared UI components
/src/features           # Domain modules (uploads, pools, picks, projections)
/src/lib                # Utils, connectors, model logic
/src/server             # Server-only utils, adapters, providers
/src/test               # Test setup & helpers
/docs                   # RFCs, milestones, briefs
/tasks                  # Small, TDD-friendly task files
/prisma                 # Schema & migrations
/prompts                # LLM prompt templates
/config                 # Model weights, configuration
```

## Data Model

### Core Entities

**Team**
- `id` (UUID)
- `nflAbbr` (string, unique) - Standard NFL abbreviations
- `name` (string)

**Game**
- `id` (UUID)
- `season` (integer)
- `week` (integer)
- `kickoff` (datetime)
- `homeTeamId` (FK to Team)
- `awayTeamId` (FK to Team)
- `venue` (string, optional)
- `lat`, `lon` (decimal, optional)
- `apiRefs` (JSONB) - External API references

**Line**
- `id` (UUID)
- `gameId` (FK to Game)
- `poolId` (FK to Pool, optional)
- `source` (string)
- `spread` (decimal, optional)
- `total` (decimal, optional)
- `moneylineHome`, `moneylineAway` (integer, optional)
- `capturedAt` (datetime)
- `isUserProvided` (boolean)

**Pool**
- `id` (UUID)
- `name` (string)
- `type` (enum: ATS, SU, POINTS_PLUS, SURVIVOR)
- `rules` (JSONB) - Pool-specific configuration

**Entry**
- `id` (UUID)
- `poolId` (FK to Pool)
- `season` (integer)

**Pick**
- `id` (UUID)
- `entryId` (FK to Entry)
- `gameId` (FK to Game)
- `teamId` (FK to Team)
- `lockedAt` (datetime, optional)
- `confidence` (decimal 0-100)
- `sourceUploadId` (FK to Upload, optional)

**Result**
- `id` (UUID)
- `gameId` (FK to Game)
- `homeScore`, `awayScore` (integer, optional)
- `status` (enum: SCHEDULED, FINAL)

**Grade**
- `id` (UUID)
- `pickId` (FK to Pick)
- `outcome` (enum: WIN, LOSS, PUSH, VOID)
- `points` (decimal)
- `details` (JSONB)

### Upload & Processing

**Upload**
- `id` (UUID)
- `kind` (enum: CSV, IMAGE)
- `path` (string)
- `parsed` (JSONB)
- `mappingProfileId` (FK to MappingProfile, optional)

**MappingProfile**
- `id` (UUID)
- `name` (string)
- `columnMap` (JSONB) - CSV column mappings

### Model Configuration

**ModelWeights**
- `id` (UUID)
- `name` (string)
- `weights` (JSONB)
- `createdAt` (datetime)

## Decision Engine

### Numeric Model (Primary)

The deterministic model computes pick confidence using weighted factors:

1. **Market Probability (50%)** - Derived from spread/total/moneyline
2. **Elo Ratings (30%)** - Team strength with weekly updates
3. **Home Advantage (7%)** - Venue benefit
4. **Rest Differential (3%)** - Days between games
5. **Weather Penalty (7%)** - Wind/precipitation impact
6. **Injury Penalty (3%)** - QB/positional cluster impacts

**Default Weights:**
```json
{
  "market_prob_weight": 0.50,
  "elo_weight": 0.30,
  "home_adv_weight": 0.07,
  "rest_weight": 0.03,
  "weather_penalty_weight": 0.07,
  "injury_penalty_weight": 0.03,
  "k_elo": 24,
  "wind_threshold_mph": 15,
  "precip_prob_threshold": 0.30,
  "qb_out_penalty": 12,
  "ol_cluster_penalty": 3,
  "db_cluster_penalty": 3
}
```

### LLM Advisor (Optional)

**Providers:** OpenAI, Anthropic, Ollama
**Modes:**
- `advice_only` (default) - Display advisory information only
- `tiebreak` - Use LLM for close numeric decisions
- `blend` - Weight-blend numeric + LLM recommendations

## Jobs & Scheduling

**Cron Jobs (node-cron):**

1. **Preweek Line Snapshot** - Thursday 06:00 ET
   - Capture current lines for games locking this week
   - Store as baseline for comparison

2. **Odds Sync** - Sunday every 15 minutes
   - Pull live lines during game day
   - Update Line entities with latest data

3. **Weather Sync** - Every 6 hours
   - Fetch weather forecasts for game venues
   - Update Game entities with conditions

4. **Grading** - Hourly Sunday-Monday overnight
   - Pull final scores when games complete
   - Grade picks according to pool rules
   - Calculate points and outcomes

## LLM Integration

### Upload Normalizer

**Purpose:** Convert OCR text or raw CSV data to structured JSON
**Model:** Any provider (configurable)
**Prompt:** System + User template with strict JSON schema
**Output:** Normalized game/line data matching database schema

### Pick Advisor

**Purpose:** Provide contextual advice and risk assessment
**Model:** Multi-provider fanout (OpenAI, Anthropic, Ollama)
**Input:** Structured feature vector from numeric model
**Output:** JSON with pick recommendation, confidence, reasoning, risk flags

### Cost & Performance Controls

- Request timeouts (configurable)
- Token limits per request
- Daily/weekly spend caps
- Fallback to numeric-only mode on failures

## Security & Configuration

### Environment Variables

**Database:**
- `DATABASE_URL` - PostgreSQL connection string

**Feature Toggles:**
- `USE_LLM_NORMALIZER` - Enable/disable OCR normalization
- `LLM_ADVISOR_ENABLED` - Enable/disable pick advisor
- `LLM_ADVISOR_MODE` - advice_only|tiebreak|blend

**LLM Configuration:**
- `LLM_ADVISOR_TIMEOUT_MS` - Request timeout
- `LLM_ADVISOR_MAX_TOKENS` - Token limit per request
- `LLM_ADVISOR_COST_CAP_USD` - Spending limit

**Provider Keys:**
- `OPENAI_API_KEY`
- `ANTHROPIC_API_KEY`  
- `OLLAMA_BASE_URL`

### Data Validation

- Strict TypeScript types throughout
- Prisma schema validation
- JSON schema validation for LLM responses
- Input sanitization for uploads

## Deployment

### Development
- Local PostgreSQL instance
- nodemon for hot reload
- Vitest + TDD Guard for continuous testing

### Production
- Docker image (Node.js 22 Alpine)
- GitHub Actions CI/CD
- Container Registry (GHCR)
- Deployment to Unraid via docker-compose

## Testing Strategy

- **Unit Tests:** Vitest + happy-dom
- **Integration Tests:** API routes + database
- **TDD Workflow:** Fail → Pass → Refactor
- **Coverage Targets:** >90% for business logic
- **Fixtures:** Mock data for uploads, API responses
- **Guards:** TDD Guard for continuous feedback

## Open Questions

1. Historical data source for Elo seeding
2. Free odds/weather API selection
3. Rate limiting strategy for external APIs
4. Backup/recovery procedures for PostgreSQL
5. Monitoring and alerting for production deployment
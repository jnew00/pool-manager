// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum PoolType {
  ATS
  SU
  POINTS_PLUS
  SURVIVOR
}

enum GameStatus {
  SCHEDULED
  IN_PROGRESS
  FINAL
  CANCELLED
}

enum PickOutcome {
  WIN
  LOSS
  PUSH
  VOID
  PENDING
}

enum UploadKind {
  CSV
  IMAGE
}

// Core entities
model Team {
  id      String @id @default(cuid())
  nflAbbr String @unique
  name    String

  // Relations
  homeGames     Game[] @relation("HomeTeam")
  awayGames     Game[] @relation("AwayTeam")
  picks         Pick[]
  survivorPicks SurvivorPick[]
  eloRating     TeamRating?

  @@map("teams")
}

model TeamRating {
  id          String   @id @default(cuid())
  teamId      String   @unique
  rating      Float    @default(1500)
  gamesPlayed Int      @default(0)
  season      Int      @default(2025)
  lastUpdated DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("team_ratings")
  @@index([season])
  @@index([rating])
}

model Game {
  id         String    @id @default(cuid())
  season     Int
  week       Int
  kickoff    DateTime
  status     GameStatus @default(SCHEDULED)
  homeTeamId String
  awayTeamId String
  venue      String?
  lat        Decimal?
  lon        Decimal?
  apiRefs    Json?

  // Relations
  homeTeam      Team     @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam      Team     @relation("AwayTeam", fields: [awayTeamId], references: [id])
  lines         Line[]
  picks         Pick[]
  survivorPicks SurvivorPick[]
  result        Result?

  @@unique([season, week, homeTeamId, awayTeamId])
  @@index([season, week])
  @@index([kickoff])
  @@map("games")
}

model Line {
  id             String   @id @default(cuid())
  gameId         String
  poolId         String?
  source         String
  spread         Decimal?
  total          Decimal?
  moneylineHome  Int?
  moneylineAway  Int?
  capturedAt     DateTime @default(now())
  isUserProvided Boolean  @default(false)

  // Relations
  game Game  @relation(fields: [gameId], references: [id])
  pool Pool? @relation(fields: [poolId], references: [id])

  @@index([gameId])
  @@index([capturedAt])
  @@map("lines")
}

model Pool {
  id          String   @id @default(cuid())
  name        String   @unique
  type        PoolType
  season      Int
  buyIn       Decimal
  maxEntries  Int
  isActive    Boolean  @default(true)
  description String?
  rules       Json?
  creatorId   String?  // User who created the pool
  url         String?  // External URL to the actual pool website

  // Relations
  entries          Entry[]
  lines            Line[]
  survivorEntries  SurvivorEntry[]
  survivorWeekData SurvivorWeekData[]
  completions      PoolCompletion[]

  @@index([season])
  @@map("pools")
}

model Entry {
  id     String @id @default(cuid())
  poolId String
  season Int

  // Relations
  pool  Pool   @relation(fields: [poolId], references: [id])
  picks Pick[]

  @@unique([poolId, season])
  @@map("entries")
}

model Pick {
  id             String    @id @default(cuid())
  entryId        String
  gameId         String
  teamId         String
  lockedAt       DateTime?
  confidence     Decimal
  sourceUploadId String?

  // Relations
  entry        Entry   @relation(fields: [entryId], references: [id])
  game         Game    @relation(fields: [gameId], references: [id])
  team         Team    @relation(fields: [teamId], references: [id])
  sourceUpload Upload? @relation(fields: [sourceUploadId], references: [id])
  grade        Grade?
  gradeOverrides GradeOverride[]

  @@unique([entryId, gameId])
  @@index([gameId])
  @@index([teamId])
  @@map("picks")
}

model Result {
  id        String     @id @default(cuid())
  gameId    String     @unique
  homeScore Int?
  awayScore Int?
  status    GameStatus @default(SCHEDULED)

  // Relations
  game Game @relation(fields: [gameId], references: [id])

  @@map("results")
}

model Grade {
  id      String      @id @default(cuid())
  pickId  String      @unique
  outcome PickOutcome
  points  Decimal
  details Json?

  // Relations
  pick Pick @relation(fields: [pickId], references: [id])

  @@map("grades")
}

model Upload {
  id               String @id @default(cuid())
  kind             UploadKind
  path             String
  parsed           Json?
  mappingProfileId String?

  // Relations
  mappingProfile MappingProfile? @relation(fields: [mappingProfileId], references: [id])
  picks          Pick[]

  @@map("uploads")
}

model MappingProfile {
  id        String @id @default(cuid())
  name      String @unique
  columnMap Json

  // Relations
  uploads Upload[]

  @@map("mapping_profiles")
}

model ModelWeights {
  id        String   @id @default(cuid())
  name      String   @unique
  weights   Json
  createdAt DateTime @default(now())

  @@map("model_weights")
}

model GradeOverride {
  id               String      @id @default(cuid())
  pickId           String
  originalOutcome  PickOutcome
  originalPoints   Decimal
  newOutcome       PickOutcome
  newPoints        Decimal
  reason           String
  overriddenAt     DateTime    @default(now())
  overriddenBy     String?

  // Relations
  pick Pick @relation(fields: [pickId], references: [id])

  @@map("grade_overrides")
}

// Survivor Pool specific models
model SurvivorEntry {
  id             String    @id @default(cuid())
  poolId         String
  userId         String?   // Optional user identifier
  entryName      String?   // Optional name for the entry
  entryUrl       String?   // Optional URL link for the entry
  eliminatedWeek Int?      // Week when eliminated (null if still active)
  strikes        Int       @default(0) // Number of strikes/mulligans used
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  pool           Pool            @relation(fields: [poolId], references: [id])
  picks          SurvivorPick[]

  @@unique([poolId, userId, entryName])
  @@index([poolId])
  @@index([isActive])
  @@map("survivor_entries")
}

model SurvivorPick {
  id              String      @id @default(cuid())
  entryId         String
  week            Int
  teamId          String
  gameId          String
  result          PickOutcome?
  marginOfVictory Int?        // Points won/lost by
  pickedAt        DateTime    @default(now())
  lockedAt        DateTime?   // When the pick was locked in

  // Relations
  entry           SurvivorEntry @relation(fields: [entryId], references: [id])
  team            Team          @relation(fields: [teamId], references: [id])
  game            Game          @relation(fields: [gameId], references: [id])

  @@unique([entryId, week])
  @@unique([entryId, teamId]) // Enforce no team reuse per entry
  @@index([week])
  @@index([teamId])
  @@map("survivor_picks")
}

model SurvivorWeekData {
  id                 String   @id @default(cuid())
  poolId             String
  week               Int
  totalEntries       Int      // Total entries at start of week
  survivingEntries   Int      // Entries that survived the week
  publicPickData     Json?    // Store public pick percentages per team
  capturedAt         DateTime @default(now())

  // Relations
  pool Pool @relation(fields: [poolId], references: [id])

  @@unique([poolId, week])
  @@index([week])
  @@map("survivor_week_data")
}

model PoolCompletion {
  id          String   @id @default(cuid())
  poolId      String
  userId      String   // User identifier (could be session ID or actual user ID)
  week        Int
  season      Int
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  pool Pool @relation(fields: [poolId], references: [id], onDelete: Cascade)

  @@unique([poolId, userId, week, season])
  @@index([userId, week, season])
  @@index([poolId])
  @@map("pool_completions")
}
